<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.DataRepository">

    <resultMap id="listDataofDepartament" type="com.example.demo.dto.DataDto">
        <result column="idData" property="idData"/>
        <result column="data" property="data"/>
        <result column="inDate" property="inDate"/>
        <result column="datatype" property="datatype"/>
        <result column="txUserId" property="txUserId"/>
        <result column="txHost" property="txHost"/>
        <result column="txDate" property="txDate"/>
        <result column="idLocation" property="idLocation"/>
    </resultMap>

    <insert id="addSingleData" parameterType="com.example.demo.domain.Data">
        INSERT INTO `data`
        (`data`, `in_date`, `id_location`, `id_datatype`, `active`, `tx_user_id`, `tx_host`, `tx_date`)
        VALUES (#{data}, #{inDate}, #{idLocation}, #{idDatatype}, 1, #{txUserId}, #{txHost}, #{txDate});
    </insert>

    <select id="getData" resultType="com.example.demo.dto.DataDto">
        SELECT a.id_data                             AS idData,
               a.data                                AS data,
               a.in_date                             AS inDate,
               a.id_location                         AS idLocation,
               (SELECT c.type
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS datatype
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = #{idDepartment}
    </select>

    <select id="getGeneralData" resultType="com.example.demo.dto.DataDto">
        SELECT a.id_data                             AS idData,
               a.data                                AS data,
               a.in_date                             AS inDate,
               a.id_location                         AS idLocation,
               (SELECT c.type
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS datatype
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = 1
        ORDER BY a.in_date
    </select>

    <select id="departmentStatistics" resultType="com.example.demo.dto.DataDto">
        SELECT SUM(a.data)                           AS data,
               MAX(a.in_date)                        AS inDate,
               a.id_location                         AS idLocation,
               (SELECT c.type
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS datatype
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = #{idDepartment}
        GROUP BY a.id_datatype
    </select>

    <select id="generalFirstVaccinated" resultType="com.example.demo.dto.DataDto">
        SELECT a.id_data                             AS idData,
               a.data                                AS data,
               a.in_date                             AS inDate,
               a.id_location                         AS idLocation,
               (SELECT c.id_datatype
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS datatype
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = #{idDepartment}
          AND a.id_datatype = 4
        ORDER BY a.in_date DESC
        LIMIT 1
    </select>

    <select id="generalSecondVaccinated" resultType="com.example.demo.dto.DataDto">
        SELECT a.id_data                             AS idData,
               a.data                                AS data,
               a.in_date                             AS inDate,
               a.id_location                         AS idLocation,
               (SELECT c.id_datatype
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS datatype
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = #{idDepartment}
          AND a.id_datatype = 5
        ORDER BY a.in_date DESC
        LIMIT 1
    </select>


    <select id="lastDataByLocation" resultType="com.example.demo.dto.DataSimpleDto">
        SELECT a.in_date as inDate, a.data as data, c.type AS datatype
        FROM data a,
             datatypes c
        WHERE a.id_location = #{idLocation}
          AND a.id_datatype = c.id_datatype
          AND a.in_date = (SELECT MAX(b.in_date) FROM data b)
    </select>

    <select id="listSpecificDataByIdDepartment" resultType="com.example.demo.dto.DataSimpleDto">
        select b.data as data, b.in_date as inDate, a.type as datatype
        from datatypes a,
             data b,
             locations l
        where a.id_datatype = #{idDatatype}
          and l.id_departament = #{idDepartment}
          and b.id_location = l.id_location
    </select>

    <!--  NOT USED  -->
    <!--
        <select id="dataofDepartament" resultMap="listDataofDepartament">
            SELECT a.id_data     AS idData,
                   a.data        AS data,
                   a.in_date     AS inDate,
                   d.type        AS datatype,
                   a.tx_user_id  AS txUserId,
                   a.tx_host     AS txHost,
                   a.tx_date     AS txDate,
                   b.id_location AS idLocation
            FROM data a,
                 locations b,
                 departments c,
                 datatypes d
            WHERE a.id_location = b.id_location
              AND b.id_department = c.id_department
              AND d.id_datatype = a.id_datatype
              AND c.id_department = #{idDepartment}
        </select>
      <select id="getGeneralAccumulateData" resultType="com.example.demo.dto.GeneralStatisticsDto">
        SELECT a.in_date as inDate, a.data as data, c.type AS datatype
        FROM data a,
             datatypes c
        WHERE a.id_location = 1
          AND a.id_datatype = c.id_datatype
          AND a.in_date = (SELECT MAX(b.in_date) FROM data b)
    </select>
    -->

</mapper>