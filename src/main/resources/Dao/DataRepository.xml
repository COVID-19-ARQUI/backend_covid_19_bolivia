<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.dao.DataRepository">

    <resultMap id="listDataofDepartament" type="com.example.demo.dto.DatoDto">
        <result column="idDato" property="idDato"/>
        <result column="data" property="data"/>
        <result column="fecha" property="fecha"/>
        <result column="tipoDeDato" property="tipoDeDato"/>
        <result column="txUser" property="txUser"/>
        <result column="txHost" property="txHost"/>
        <result column="txDate" property="txDate"/>
        <result column="idZona" property="idZona"/>
    </resultMap>

    <select id="getDatos" resultType="com.example.demo.dto.DatoDto">
        SELECT a.id_data                             AS idDato,
               a.data                                AS data,
               a.in_date                             AS fecha,
               a.id_location                         AS zonaId,
               (SELECT c.type
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS tipoDeDato
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = #{idDepartment}
    </select>

    <select id="getDatosGenerales" resultType="com.example.demo.dto.DatoDto">
        SELECT a.id_data                             AS idDato,
               a.data                                AS data,
               a.in_date                             AS fecha,
               a.id_location                         AS zonaId,
               (SELECT c.type
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS tipoDeDato
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = 1
        ORDER BY a.in_date
    </select>

    <select id="sumdato" resultType="com.example.demo.dto.DatoDto">
        SELECT a.id_data                             AS idDato,
               sum(a.data)                           AS data,
               a.in_date                             AS fecha,
               a.id_location                         AS zonaId,
               (SELECT c.type
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS tipoDeDato
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = #{idDepartment}
        GROUP BY a.id_datatype
    </select>

    <select id="vacuna1final" resultType="com.example.demo.dto.DatoDto">
        SELECT a.id_data                             AS idDato,
               a.data                                AS data,
               a.in_date                             AS fecha,
               a.id_location                         AS zonaId,
               (SELECT c.id_datatype
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS tipoDeDato
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = #{idDepartment}
          AND a.id_datatype = 4
        ORDER BY a.in_date DESC
        LIMIT 1
    </select>

    <select id="vacuna2final" resultType="com.example.demo.dto.DatoDto">
        SELECT a.id_data                             AS idDato,
               a.data                                AS data,
               a.in_date                             AS fecha,
               a.id_location                         AS zonaId,
               (SELECT c.id_datatype
                FROM datatypes c
                WHERE a.id_datatype = c.id_datatype) AS tipoDeDato
        FROM data a,
             locations b
        WHERE b.id_location = a.id_location
          AND b.id_departament = #{idDepartment}
          AND a.id_datatype = 5
        ORDER BY a.in_date DESC
        LIMIT 1
    </select>

    <select id="dataofDepartament" resultMap="listDataofDepartament">
        SELECT a.id_data     AS idDato,
               a.data        AS data,
               a.in_date     AS fecha,
               d.type        AS tipoDeDato,
               a.tx_user_id  AS txUser,
               a.tx_host     AS txHost,
               a.tx_date     AS txDate,
               b.id_location AS idZona
        FROM data a,
             locations b,
             departaments c,
             datatypes d
        WHERE a.id_location = b.id_location
          AND b.id_departament = c.id_departament
          AND d.id_datatype = a.id_datatype
          AND c.id_departament = #{idDepartment}
    </select>

    <insert id="addSingleData" parameterType="com.example.demo.domain.Data">
        INSERT INTO `data` (`data`, `in_date`, `id_location`, `id_datatype`, `tx_user_id`, `tx_host`, `tx_date`)
        VALUES (#{data}, #{fecha}, #{zonaId}, #{tipodedatoId}, #{txUser}, #{txHost}, #{txDate});
    </insert>

    <select id="mostRecentDateOfCovidData" resultType="com.example.demo.dto.DateCovidDto">
        SELECT a.in_date, a.data, c.type AS tipoDeDatos
        FROM data a,
             datatypes c
        WHERE a.id_location = 1
          AND a.id_datatype = c.id_datatype
          AND a.in_date = (SELECT MAX(b.in_date) FROM data b)
    </select>

    <select id="getGeneralAccumulateData" resultType="com.example.demo.dto.GeneralDataDto">
        SELECT a.in_date, a.data, c.type AS tipoDeDatos
        FROM data a,
             datatypes c
        WHERE a.id_location = 1
          AND a.id_datatype = c.id_datatype
          AND a.in_date = (SELECT MAX(b.in_date) FROM data b)
    </select>

    <select id="listDataOfDepartmentAndTypeDate" resultType="com.example.demo.dto.DataCovidDepartmentDto">
        select b.data, b.in_date
        from datatypes a,
             data b,
             locations c,
             departaments d
        where a.id_datatype = #{tipoDatoId}
          and d.id_departament = #{departmentId}
          and d.id_departament = c.id_departament
          and b.id_location = c.id_location
          and a.id_datatype = b.id_location
    </select>


</mapper>